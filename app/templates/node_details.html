{% extends "base.html" %}

{% block title %}Proxmox UI - Node Details{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('host_details', host_id=host_id) }}">{{ host_id }}</a></li>
        <li class="breadcrumb-item active">{{ node }}</li>
    </ol>
</nav>

<div class="row mb-4">
    <div class="col">
        <h1><i class="fas fa-server"></i> Node: {{ node }}</h1>
    </div>
    <div class="col-auto">
        <div class="btn-group" role="group">
            <a href="{{ url_for('create_vm', host_id=host_id, node=node) }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Create VM
            </a>
            <a href="{{ url_for('create_container', host_id=host_id, node=node) }}" class="btn btn-success">
                <i class="fas fa-plus"></i> Create Container
            </a>
            <a href="{{ url_for('template_management', host_id=host_id, node=node) }}" class="btn btn-secondary">
                <i class="fas fa-box-open"></i> Templates
            </a>
            <a href="{{ url_for('node_network', host_id=host_id, node=node) }}" class="btn btn-info">
                <i class="fas fa-network-wired"></i> Network
            </a>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Node Status</h5>
            </div>
            <div class="card-body">
                <p><strong>CPU Usage:</strong> {{ "%.2f"|format(node_status.cpu * 100) }}%</p>
                <div class="progress mb-3">
                    <div class="progress-bar" role="progressbar" style="width: {{ node_status.cpu * 100 }}%" 
                        aria-valuenow="{{ node_status.cpu * 100 }}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                
                <p><strong>Memory:</strong> {{ (node_status.memory.used / (1024*1024*1024))|round(2) }} GB / {{ (node_status.memory.total / (1024*1024*1024))|round(2) }} GB</p>
                <div class="progress mb-3">
                    <div class="progress-bar" role="progressbar" 
                        style="width: {{ (node_status.memory.used / node_status.memory.total * 100)|round(2) }}%" 
                        aria-valuenow="{{ (node_status.memory.used / node_status.memory.total * 100)|round(2) }}" 
                        aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                
                <p><strong>Uptime:</strong> {{ (node_status.uptime / 86400)|round(1) }} days</p>
            </div>
        </div>
    </div>
</div>

<ul class="nav nav-tabs mb-4" id="nodeTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="vms-tab" data-bs-toggle="tab" data-bs-target="#vms" type="button" role="tab" aria-controls="vms" aria-selected="true">
            Virtual Machines
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="containers-tab" data-bs-toggle="tab" data-bs-target="#containers" type="button" role="tab" aria-controls="containers" aria-selected="false">
            Containers
        </button>
    </li>
</ul>

<div class="tab-content" id="nodeTabContent">
    <div class="tab-pane fade show active" id="vms" role="tabpanel" aria-labelledby="vms-tab">
        <div class="card">
            <div class="card-header">
                <h5>Virtual Machines</h5>
            </div>
            <div class="card-body">
                {% if vms %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="vmsTable">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="vmid">VMID <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="name">Name <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="status">Status <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="memory">Memory <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="cpu">CPU <i class="fas fa-sort"></i></th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vm in vms %}
                                <tr>
                                    <td data-value="{{ vm.vmid }}">{{ vm.vmid }}</td>
                                    <td data-value="{{ vm.name }}">{{ vm.name }}</td>
                                    <td data-value="{{ vm.status }}">
                                        {% if vm.status == 'running' %}
                                            <span class="badge bg-success">Running</span>
                                        {% elif vm.status == 'stopped' %}
                                            <span class="badge bg-danger">Stopped</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ vm.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td data-value="{{ vm.maxmem }}">{{ (vm.maxmem / (1024*1024))|round(0) }} MB</td>
                                    <td data-value="{% if vm.cpus is defined %}{{ vm.cpus }}{% elif vm.maxcpu is defined %}{{ vm.maxcpu }}{% else %}0{% endif %}">
                                        {% if vm.cpus is defined %}
                                            {{ vm.cpus }}
                                        {% elif vm.maxcpu is defined %}
                                            {{ vm.maxcpu }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('vm_details', host_id=host_id, node=node, vmid=vm.vmid) }}" class="btn btn-info btn-sm">
                                                <i class="fas fa-info-circle"></i>
                                            </a>
                                            
                                            {% if vm.status == 'running' %}
                                                <button type="button" class="btn btn-warning btn-sm vm-action" data-action="shutdown" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ vm.vmid }}">
                                                    <i class="fas fa-power-off"></i>
                                                </button>
                                                <button type="button" class="btn btn-danger btn-sm vm-action" data-action="stop" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ vm.vmid }}">
                                                    <i class="fas fa-stop"></i>
                                                </button>
                                                <button type="button" class="btn btn-secondary btn-sm vm-action" data-action="reset" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ vm.vmid }}">
                                                    <i class="fas fa-redo"></i>
                                                </button>
                                            {% else %}
                                                <button type="button" class="btn btn-success btn-sm vm-action" data-action="start" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ vm.vmid }}">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info">No virtual machines found on this node.</div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="tab-pane fade" id="containers" role="tabpanel" aria-labelledby="containers-tab">
        <div class="card">
            <div class="card-header">
                <h5>Containers</h5>
            </div>
            <div class="card-body">
                {% if containers %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="containersTable">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="ctid">CTID <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="name">Name <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="status">Status <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="memory">Memory <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="cpu">CPU <i class="fas fa-sort"></i></th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for container in containers %}
                                <tr>
                                    <td data-value="{{ container.vmid }}">{{ container.vmid }}</td>
                                    <td data-value="{{ container.name }}">{{ container.name }}</td>
                                    <td data-value="{{ container.status }}">
                                        {% if container.status == 'running' %}
                                            <span class="badge bg-success">Running</span>
                                        {% elif container.status == 'stopped' %}
                                            <span class="badge bg-danger">Stopped</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ container.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td data-value="{{ container.maxmem }}">{{ (container.maxmem / (1024*1024))|round(0) }} MB</td>
                                    <td data-value="{% if container.cpus is defined %}{{ container.cpus }}{% elif container.maxcpu is defined %}{{ container.maxcpu }}{% else %}0{% endif %}">
                                        {% if container.cpus is defined %}
                                            {{ container.cpus }}
                                        {% elif container.maxcpu is defined %}
                                            {{ container.maxcpu }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('container_details', host_id=host_id, node=node, vmid=container.vmid) }}" class="btn btn-info btn-sm">
                                                <i class="fas fa-info-circle"></i>
                                            </a>
                                            
                                            {% if container.status == 'running' %}
                                                <button type="button" class="btn btn-warning btn-sm container-action" data-action="shutdown" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ container.vmid }}">
                                                    <i class="fas fa-power-off"></i>
                                                </button>
                                                <button type="button" class="btn btn-danger btn-sm container-action" data-action="stop" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ container.vmid }}">
                                                    <i class="fas fa-stop"></i>
                                                </button>
                                            {% else %}
                                                <button type="button" class="btn btn-success btn-sm container-action" data-action="start" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ container.vmid }}">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info">No containers found on this node.</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        $('.vm-action').click(function() {
            const action = $(this).data('action');
            const hostId = $(this).data('host-id');
            const node = $(this).data('node');
            const vmid = $(this).data('vmid');
            
            if (confirm(`Are you sure you want to ${action} VM ${vmid}?`)) {
                $.post('/api/vm/action', {
                    host_id: hostId,
                    node: node,
                    vmid: vmid,
                    action: action
                }).done(function(data) {
                    if (data.success) {
                        alert('Action was successful. Page will reload.');
                        location.reload();
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                }).fail(function() {
                    alert('Failed to perform action. Please try again.');
                });
            }
        });
        
        $('.container-action').click(function() {
            const action = $(this).data('action');
            const hostId = $(this).data('host-id');
            const node = $(this).data('node');
            const vmid = $(this).data('vmid');
            
            if (confirm(`Are you sure you want to ${action} container ${vmid}?`)) {
                $.post('/api/container/action', {
                    host_id: hostId,
                    node: node,
                    vmid: vmid,
                    action: action
                }).done(function(data) {
                    if (data.success) {
                        alert('Action was successful. Page will reload.');
                        location.reload();
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                }).fail(function() {
                    alert('Failed to perform action. Please try again.');
                });
            }
        });
    });
</script>
{% endblock %}