{% extends "base.html" %}

{% block title %}Proxmox UI - Node Details{% endblock %}

{% block content %}
<div class="breadcrumb-container py-2 px-3 mb-3 position-relative w-100 rounded-3 bg-dark">
    <nav aria-label="breadcrumb" class="d-flex justify-content-between align-items-center">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}" class="text-light">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('host_details', host_id=host_id) }}" class="text-light">{{ host_id }}</a></li>
            <li class="breadcrumb-item active text-light">{{ node }}</li>
        </ol>
        <div class="d-flex flex-wrap gap-1">
            <a href="{{ url_for('create_vm', host_id=host_id, node=node) }}" class="btn btn-sm btn-outline-light">
                <i class="fas fa-plus-circle"></i> Create VM
            </a>
            <a href="{{ url_for('create_container', host_id=host_id, node=node) }}" class="btn btn-sm btn-outline-light">
                <i class="fas fa-plus-circle"></i> Create CT
            </a>
            <a href="{{ url_for('batch_create', host_id=host_id, node=node) }}" class="btn btn-sm btn-outline-light">
                <i class="fas fa-layer-group"></i> Batch Create
            </a>
            <a href="{{ url_for('batch_config', host_id=host_id, node=node) }}" class="btn btn-sm btn-outline-light">
                <i class="fas fa-sliders-h"></i> Batch Config
            </a>
            <a href="{{ url_for('template_management', host_id=host_id, node=node) }}" class="btn btn-sm btn-outline-light">
                <i class="fas fa-box-open"></i> Templates
            </a>
            <a href="{{ url_for('node_network', host_id=host_id, node=node) }}" class="btn btn-sm btn-outline-light">
                <i class="fas fa-network-wired"></i> Network
            </a>
            <a href="{{ url_for('node_firewall', host_id=host_id, node=node) }}" class="btn btn-sm btn-outline-light">
                <i class="fas fa-shield-alt"></i> Firewall
            </a>
            <a href="{{ url_for('node_metrics', host_id=host_id, node=node) }}" class="btn btn-sm btn-outline-light">
                <i class="fas fa-chart-line"></i> Metrics
            </a>
            <a href="{{ url_for('migrate_vm_form', host_id=host_id) }}" class="btn btn-sm btn-outline-light">
                <i class="fas fa-exchange-alt"></i> Migrate
            </a>
            <a href="{{ url_for('node_maintenance', host_id=host_id, node=node) }}" class="btn btn-sm btn-outline-light">
                <i class="fas fa-wrench"></i> Maintenance
            </a>
        </div>
    </nav>
</div>

<div class="row mb-4">
    <div class="col">
        <!-- <h1><i class="fas fa-server"></i> Node: {{ node }}</h1> -->
    </div>
</div>

<!-- Resource Alerts Container -->
<div id="node-resource-alerts-container"></div>

<!-- Resource Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-success text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-0">Virtual Machines</h6>
                        <h1 class="mt-2 mb-0 display-5">{{ vms|length }}</h1>
                        <small>{{ vms|selectattr('status', 'equalto', 'running')|list|length }} running</small>
                    </div>
                    <div>
                        <i class="fas fa-desktop fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-0">Containers</h6>
                        <h1 class="mt-2 mb-0 display-5">{{ containers|length }}</h1>
                        <small>{{ containers|selectattr('status', 'equalto', 'running')|list|length }} running</small>
                    </div>
                    <div>
                        <i class="fas fa-cube fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-secondary text-white h-100">
            <div class="card-body">
                <div>
                    <h6 class="card-title mb-0"><i class="fas fa-heartbeat me-1"></i> Health</h6>
                    
                    <!-- CPU Health -->
                    <div class="d-flex align-items-center mt-2">
                        <small><i class="fas fa-microchip me-1"></i>CPU:</small>
                        <div class="progress ms-2 flex-grow-1" style="height: 0.6rem;">
                            <div class="progress-bar 
                                {% if node_status.cpu * 100 < 50 %}
                                    bg-success
                                {% elif node_status.cpu * 100 < 80 %}
                                    bg-warning
                                {% else %}
                                    bg-danger
                                {% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ node_status.cpu * 100 }}%;" 
                                 aria-valuenow="{{ node_status.cpu * 100 }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <small class="ms-1">{{ (node_status.cpu * 100)|round(1) }}%</small>
                    </div>
                    
                    <!-- Memory Health -->
                    <div class="d-flex align-items-center mt-2">
                        <small><i class="fas fa-memory me-1"></i>RAM:</small>
                        <div class="progress ms-2 flex-grow-1" style="height: 0.6rem;">
                            <div class="progress-bar 
                                {% if (node_status.memory.used / node_status.memory.total * 100) < 50 %}
                                    bg-success
                                {% elif (node_status.memory.used / node_status.memory.total * 100) < 80 %}
                                    bg-warning
                                {% else %}
                                    bg-danger
                                {% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ (node_status.memory.used / node_status.memory.total * 100)|round(2) }}%;" 
                                 aria-valuenow="{{ (node_status.memory.used / node_status.memory.total * 100)|round(2) }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <small class="ms-1">{{ (node_status.memory.used / node_status.memory.total * 100)|round(1) }}%</small>
                    </div>
                    
                    <!-- Storage Health -->
                    <div class="d-flex align-items-center mt-2">
                        <small><i class="fas fa-hdd me-1"></i>Disk:</small>
                        <div class="progress ms-2 flex-grow-1" style="height: 0.6rem;">
                            <div class="progress-bar 
                                {% if node_status.rootfs.used / node_status.rootfs.total * 100 < 50 %}
                                    bg-success
                                {% elif node_status.rootfs.used / node_status.rootfs.total * 100 < 80 %}
                                    bg-warning
                                {% else %}
                                    bg-danger
                                {% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ node_status.rootfs.used / node_status.rootfs.total * 100 }}%;" 
                                 aria-valuenow="{{ node_status.rootfs.used / node_status.rootfs.total * 100 }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <small class="ms-1">{{ (node_status.rootfs.used / node_status.rootfs.total * 100)|round(1) }}%</small>
                    </div>
                </div>
                
                <div class="mt-3 pt-2 border-top border-light">
                    <small class="text-light">Uptime:</small>
                    <div class="uptime-display">{{ (node_status.uptime / 86400)|round(1) }} days</div>
                </div>
            </div>
        </div>
    </div>
</div>

<ul class="nav nav-tabs mb-4" id="nodeTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="vms-tab" data-bs-toggle="tab" data-bs-target="#vms" type="button" role="tab" aria-controls="vms" aria-selected="true">
            Virtual Machines
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="containers-tab" data-bs-toggle="tab" data-bs-target="#containers" type="button" role="tab" aria-controls="containers" aria-selected="false">
            Containers
        </button>
    </li>
</ul>

<div class="tab-content" id="nodeTabContent">
    <div class="tab-pane fade show active" id="vms" role="tabpanel" aria-labelledby="vms-tab">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="bulk-actions-vm d-none">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-success btn-sm bulk-action-vm" data-action="start">
                            <i class="fas fa-play"></i> Start Selected
                        </button>
                        <button type="button" class="btn btn-warning btn-sm bulk-action-vm" data-action="shutdown">
                            <i class="fas fa-power-off"></i> Shutdown Selected
                        </button>
                        <button type="button" class="btn btn-danger btn-sm bulk-action-vm" data-action="stop">
                            <i class="fas fa-stop"></i> Stop Selected
                        </button>
                        <button type="button" class="btn btn-primary btn-sm bulk-migrate-btn" data-type="qemu">
                            <i class="fas fa-exchange-alt"></i> Migrate Selected
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" id="vm-select-none">
                            <i class="fas fa-times"></i> Clear Selection
                        </button>
                    </div>
                    <span class="ms-2 badge bg-primary" id="vm-selected-count">0 selected</span>
                </div>
            </div>
            <div class="card-body">
                {% if vms %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="vmsTable">
                            <thead>
                                <tr>
                                    <th>
                                        <div class="form-check">
                                            <input class="form-check-input select-all-vm" type="checkbox" value="" id="select-all-vm">
                                            <label class="form-check-label" for="select-all-vm"></label>
                                        </div>
                                    </th>
                                    <th class="sortable" data-sort="vmid">VMID <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="name">Name <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="status">Status <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="memory">Memory <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="cpu">CPU <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="tags">Tags <i class="fas fa-sort"></i></th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vm in vms %}
                                <tr>
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input vm-checkbox" type="checkbox" 
                                                data-vmid="{{ vm.vmid }}" data-status="{{ vm.status }}" data-node="{{ node }}">
                                        </div>
                                    </td>
                                    <td data-value="{{ vm.vmid }}">{{ vm.vmid }}</td>
                                    <td data-value="{{ vm.name }}">{{ vm.name }}</td>
                                    <td data-value="{{ vm.status }}">
                                        {% if vm.status == 'running' %}
                                            <span class="badge bg-success">Running</span>
                                        {% elif vm.status == 'stopped' %}
                                            <span class="badge bg-danger">Stopped</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ vm.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td data-value="{{ vm.maxmem }}">{{ (vm.maxmem / (1024*1024))|round(0) }} MB</td>
                                    <td data-value="{% if vm.cpus is defined %}{{ vm.cpus }}{% elif vm.maxcpu is defined %}{{ vm.maxcpu }}{% else %}0{% endif %}">
                                        {% if vm.cpus is defined %}
                                            {{ vm.cpus }}
                                        {% elif vm.maxcpu is defined %}
                                            {{ vm.maxcpu }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td data-value="{{ vm.tags|default('') }}">
                                        {% if vm.tags is defined and vm.tags %}
                                            {% for tag in vm.tags.split(',') %}
                                                <span class="badge bg-info">{{ tag }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <small class="text-muted">No tags</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('vm_details', host_id=host_id, node=node, vmid=vm.vmid) }}" class="btn btn-info btn-sm">
                                                <i class="fas fa-info-circle"></i>
                                            </a>
                                            
                                            {% if vm.status == 'running' %}
                                                <button type="button" class="btn btn-warning btn-sm vm-action" data-action="shutdown" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ vm.vmid }}">
                                                    <i class="fas fa-power-off"></i>
                                                </button>
                                                <button type="button" class="btn btn-danger btn-sm vm-action" data-action="stop" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ vm.vmid }}">
                                                    <i class="fas fa-stop"></i>
                                                </button>
                                                <button type="button" class="btn btn-secondary btn-sm vm-action" data-action="reset" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ vm.vmid }}">
                                                    <i class="fas fa-redo"></i>
                                                </button>
                                            {% else %}
                                                <button type="button" class="btn btn-success btn-sm vm-action" data-action="start" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ vm.vmid }}">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info">No virtual machines found on this node.</div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="tab-pane fade" id="containers" role="tabpanel" aria-labelledby="containers-tab">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="bulk-actions-ct d-none">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-success btn-sm bulk-action-ct" data-action="start">
                            <i class="fas fa-play"></i> Start Selected
                        </button>
                        <button type="button" class="btn btn-warning btn-sm bulk-action-ct" data-action="shutdown">
                            <i class="fas fa-power-off"></i> Shutdown Selected
                        </button>
                        <button type="button" class="btn btn-danger btn-sm bulk-action-ct" data-action="stop">
                            <i class="fas fa-stop"></i> Stop Selected
                        </button>
                        <button type="button" class="btn btn-primary btn-sm bulk-migrate-btn" data-type="lxc">
                            <i class="fas fa-exchange-alt"></i> Migrate Selected
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" id="ct-select-none">
                            <i class="fas fa-times"></i> Clear Selection
                        </button>
                    </div>
                    <span class="ms-2 badge bg-primary" id="ct-selected-count">0 selected</span>
                </div>
            </div>
            <div class="card-body">
                {% if containers %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="containersTable">
                            <thead>
                                <tr>
                                    <th>
                                        <div class="form-check">
                                            <input class="form-check-input select-all-ct" type="checkbox" value="" id="select-all-ct">
                                            <label class="form-check-label" for="select-all-ct"></label>
                                        </div>
                                    </th>
                                    <th class="sortable" data-sort="ctid">CTID <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="name">Name <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="status">Status <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="memory">Memory <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="cpu">CPU <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="tags">Tags <i class="fas fa-sort"></i></th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for container in containers %}
                                <tr>
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input ct-checkbox" type="checkbox" 
                                                data-vmid="{{ container.vmid }}" data-status="{{ container.status }}" data-node="{{ node }}">
                                        </div>
                                    </td>
                                    <td data-value="{{ container.vmid }}">{{ container.vmid }}</td>
                                    <td data-value="{{ container.name }}">{{ container.name }}</td>
                                    <td data-value="{{ container.status }}">
                                        {% if container.status == 'running' %}
                                            <span class="badge bg-success">Running</span>
                                        {% elif container.status == 'stopped' %}
                                            <span class="badge bg-danger">Stopped</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ container.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td data-value="{{ container.maxmem }}">{{ (container.maxmem / (1024*1024))|round(0) }} MB</td>
                                    <td data-value="{% if container.cpus is defined %}{{ container.cpus }}{% elif container.maxcpu is defined %}{{ container.maxcpu }}{% else %}0{% endif %}">
                                        {% if container.cpus is defined %}
                                            {{ container.cpus }}
                                        {% elif container.maxcpu is defined %}
                                            {{ container.maxcpu }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td data-value="{{ container.tags|default('') }}">
                                        {% if container.tags is defined and container.tags %}
                                            {% for tag in container.tags.split(',') %}
                                                <span class="badge bg-info">{{ tag }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <small class="text-muted">No tags</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('container_details', host_id=host_id, node=node, vmid=container.vmid) }}" class="btn btn-info btn-sm">
                                                <i class="fas fa-info-circle"></i>
                                            </a>
                                            
                                            {% if container.status == 'running' %}
                                                <button type="button" class="btn btn-warning btn-sm container-action" data-action="shutdown" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ container.vmid }}">
                                                    <i class="fas fa-power-off"></i>
                                                </button>
                                                <button type="button" class="btn btn-danger btn-sm container-action" data-action="stop" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ container.vmid }}">
                                                    <i class="fas fa-stop"></i>
                                                </button>
                                            {% else %}
                                                <button type="button" class="btn btn-success btn-sm container-action" data-action="start" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ container.vmid }}">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info">No containers found on this node.</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Bulk Migration Modal -->
<div class="modal fade" id="bulkMigrateModal" tabindex="-1" aria-labelledby="bulkMigrateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkMigrateModalLabel">Migrate Selected Resources</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bulkMigrateForm">
                    <input type="hidden" id="bulkMigrateType" name="vm_type">
                    <input type="hidden" id="bulkMigrateItems" name="items">
                    
                    <div class="mb-3">
                        <label for="bulkTargetNode" class="form-label">Target Node</label>
                        <select class="form-select" id="bulkTargetNode" name="target_node" required>
                            <option value="">Select target node</option>
                            {% for node_obj in nodes %}
                                {% if node_obj.node != node %}
                                    <option value="{{ node_obj.node }}">{{ node_obj.node }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="bulkOnline" name="online">
                        <label class="form-check-label" for="bulkOnline">Online Migration</label>
                        <div class="form-text">If checked, resources will be live-migrated without downtime. This requires running resources.</div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="bulkWithLocalDisks" name="with_local_disks">
                        <label class="form-check-label" for="bulkWithLocalDisks">With Local Disks</label>
                        <div class="form-text">If checked, local disks will be migrated as well (slower but maintains integrity).</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="startBulkMigrate">Start Migration</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Individual VM/Container actions
        $('.vm-action').click(function() {
            const action = $(this).data('action');
            const hostId = $(this).data('host-id');
            const node = $(this).data('node');
            const vmid = $(this).data('vmid');
            
            if (confirm(`Are you sure you want to ${action} VM ${vmid}?`)) {
                $.post('/api/vm/action', {
                    host_id: hostId,
                    node: node,
                    vmid: vmid,
                    action: action
                }).done(function(data) {
                    if (data.success) {
                        alert('Action was successful. Page will reload.');
                        location.reload();
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                }).fail(function() {
                    alert('Failed to perform action. Please try again.');
                });
            }
        });
        
        $('.container-action').click(function() {
            const action = $(this).data('action');
            const hostId = $(this).data('host-id');
            const node = $(this).data('node');
            const vmid = $(this).data('vmid');
            
            if (confirm(`Are you sure you want to ${action} container ${vmid}?`)) {
                $.post('/api/container/action', {
                    host_id: hostId,
                    node: node,
                    vmid: vmid,
                    action: action
                }).done(function(data) {
                    if (data.success) {
                        alert('Action was successful. Page will reload.');
                        location.reload();
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                }).fail(function() {
                    alert('Failed to perform action. Please try again.');
                });
            }
        });

        // Bulk selection management for VMs
        $('.vm-checkbox').change(function() {
            updateBulkActionsVisibility('vm');
        });

        $('.select-all-vm').change(function() {
            $('.vm-checkbox').prop('checked', $(this).prop('checked'));
            updateBulkActionsVisibility('vm');
        });

        $('#vm-select-none').click(function() {
            $('.vm-checkbox, .select-all-vm').prop('checked', false);
            updateBulkActionsVisibility('vm');
        });

        // Bulk selection management for Containers
        $('.ct-checkbox').change(function() {
            updateBulkActionsVisibility('ct');
        });

        $('.select-all-ct').change(function() {
            $('.ct-checkbox').prop('checked', $(this).prop('checked'));
            updateBulkActionsVisibility('ct');
        });

        $('#ct-select-none').click(function() {
            $('.ct-checkbox, .select-all-ct').prop('checked', false);
            updateBulkActionsVisibility('ct');
        });

        // Function to update bulk actions visibility
        function updateBulkActionsVisibility(type) {
            const checkboxSelector = type === 'vm' ? '.vm-checkbox:checked' : '.ct-checkbox:checked';
            const actionsSelector = type === 'vm' ? '.bulk-actions-vm' : '.bulk-actions-ct';
            const countSelector = type === 'vm' ? '#vm-selected-count' : '#ct-selected-count';
            
            const selectedCount = $(checkboxSelector).length;
            
            if (selectedCount > 0) {
                $(actionsSelector).removeClass('d-none');
                $(countSelector).text(`${selectedCount} selected`);
            } else {
                $(actionsSelector).addClass('d-none');
            }
        }

        // Bulk actions for VMs
        $('.bulk-action-vm').click(function() {
            const action = $(this).data('action');
            const hostId = '{{ host_id }}';
            const selectedVMs = [];
            
            $('.vm-checkbox:checked').each(function() {
                selectedVMs.push({
                    node: $(this).data('node'),
                    vmid: $(this).data('vmid'),
                    status: $(this).data('status')
                });
            });
            
            if (selectedVMs.length === 0) {
                alert('No VMs selected.');
                return;
            }
            
            // Filter VMs based on action
            let actionableVMs = selectedVMs;
            if (action === 'start') {
                actionableVMs = selectedVMs.filter(vm => vm.status !== 'running');
            } else if (action === 'stop' || action === 'shutdown') {
                actionableVMs = selectedVMs.filter(vm => vm.status === 'running');
            }
            
            if (actionableVMs.length === 0) {
                alert(`No VMs in a state where the "${action}" action can be performed.`);
                return;
            }
            
            if (confirm(`Are you sure you want to ${action} ${actionableVMs.length} VMs?`)) {
                $.post('/api/bulk/vm/action', {
                    host_id: hostId,
                    vms: JSON.stringify(actionableVMs),
                    action: action
                }).done(function(data) {
                    if (data.success) {
                        alert(`Action initiated for ${data.processed} VMs. Page will reload.`);
                        location.reload();
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                }).fail(function() {
                    alert('Failed to perform bulk action. Please try again.');
                });
            }
        });

        // Bulk actions for Containers
        $('.bulk-action-ct').click(function() {
            const action = $(this).data('action');
            const hostId = '{{ host_id }}';
            const selectedContainers = [];
            
            $('.ct-checkbox:checked').each(function() {
                selectedContainers.push({
                    node: $(this).data('node'),
                    vmid: $(this).data('vmid'),
                    status: $(this).data('status')
                });
            });
            
            if (selectedContainers.length === 0) {
                alert('No containers selected.');
                return;
            }
            
            // Filter containers based on action
            let actionableContainers = selectedContainers;
            if (action === 'start') {
                actionableContainers = selectedContainers.filter(container => container.status !== 'running');
            } else if (action === 'stop' || action === 'shutdown') {
                actionableContainers = selectedContainers.filter(container => container.status === 'running');
            }
            
            if (actionableContainers.length === 0) {
                alert(`No containers in a state where the "${action}" action can be performed.`);
                return;
            }
            
            if (confirm(`Are you sure you want to ${action} ${actionableContainers.length} containers?`)) {
                $.post('/api/bulk/container/action', {
                    host_id: hostId,
                    containers: JSON.stringify(actionableContainers),
                    action: action
                }).done(function(data) {
                    if (data.success) {
                        alert(`Action initiated for ${data.processed} containers. Page will reload.`);
                        location.reload();
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                }).fail(function() {
                    alert('Failed to perform bulk action. Please try again.');
                });
            }
        });

        // Bulk migration
        $('.bulk-migrate-btn').click(function() {
            const type = $(this).data('type');
            const selector = type === 'qemu' ? '.vm-checkbox:checked' : '.ct-checkbox:checked';
            const items = [];
            
            $(selector).each(function() {
                items.push({
                    node: $(this).data('node'),
                    vmid: $(this).data('vmid'),
                    status: $(this).data('status')
                });
            });
            
            if (items.length === 0) {
                alert('No resources selected for migration.');
                return;
            }
            
            // Set modal values
            $('#bulkMigrateType').val(type);
            $('#bulkMigrateItems').val(JSON.stringify(items));
            
            // Handle online migration option based on selected resources
            const hasRunning = items.some(item => item.status === 'running');
            if (!hasRunning) {
                $('#bulkOnline').prop('checked', false).prop('disabled', true);
            } else {
                $('#bulkOnline').prop('disabled', false);
            }
            
            // Show the migration modal
            const migrateModal = new bootstrap.Modal(document.getElementById('bulkMigrateModal'));
            migrateModal.show();
        });

        // Start bulk migration
        $('#startBulkMigrate').click(function() {
            const hostId = '{{ host_id }}';
            const type = $('#bulkMigrateType').val();
            const items = JSON.parse($('#bulkMigrateItems').val());
            const targetNode = $('#bulkTargetNode').val();
            const online = $('#bulkOnline').prop('checked');
            const withLocalDisks = $('#bulkWithLocalDisks').prop('checked');
            
            if (!targetNode) {
                alert('Please select a target node.');
                return;
            }
            
            if (confirm(`Are you sure you want to migrate ${items.length} resources to node ${targetNode}?`)) {
                $.post('/api/bulk/migrate', {
                    host_id: hostId,
                    items: $('#bulkMigrateItems').val(),
                    type: type,
                    target_node: targetNode,
                    online: online,
                    with_local_disks: withLocalDisks
                }).done(function(data) {
                    if (data.success) {
                        alert(`Migration initiated for ${data.processed} resources. Page will reload.`);
                        location.reload();
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                }).fail(function() {
                    alert('Failed to start migration. Please try again.');
                });
                
                // Hide the modal
                bootstrap.Modal.getInstance(document.getElementById('bulkMigrateModal')).hide();
            }
        });

        // Check node resources against thresholds and display alerts if needed
        const nodeData = {
            name: '{{ node }}',
            host_id: '{{ host_id }}',
            cpu: {{ node_status.cpu * 100 }},
            memory_percent: {{ (node_status.memory.used / node_status.memory.total * 100)|round(2) }},
            memory_used: {{ (node_status.memory.used / (1024*1024*1024))|round(2) }},
            memory_total: {{ (node_status.memory.total / (1024*1024*1024))|round(2) }},
            storage_percent: {{ (node_status.rootfs.used / node_status.rootfs.total * 100)|round(2) }}
        };
        
        // Check resource thresholds
        ResourceAlerts.checkNodeResources(nodeData);
        
        // Check VM resources if they are running
        {% if vms is defined %}
        {% for vm in vms %}
        {% if vm.status == 'running' %}
        const vmData = {
            vmid: '{{ vm.vmid }}',
            name: '{{ vm.name }}',
            node: '{{ node }}',
            status: '{{ vm.status }}',
            cpu: {{ vm.cpu|default(0) }},
            mem: {{ vm.mem|default(0) }},
            maxmem: {{ vm.maxmem|default(1) }}
            {% if vm.get('disks') %}
            ,
            disks: {
                {% for key, disk in vm.get('disks', {}).items() %}
                {% if disk.get('usage') is defined and disk.get('total') is defined %}
                '{{ key }}': {
                    usage: {{ disk.get('usage') }},
                    total: {{ disk.get('total') }}
                }{% if not loop.last %},{% endif %}
                {% endif %}
                {% endfor %}
            }
            {% endif %}
        };
        ResourceAlerts.checkVmResources(vmData);
        {% endif %}
        {% endfor %}
        {% endif %}
        
        // Check container resources if they are running
        {% if containers is defined %}
        {% for container in containers %}
        {% if container.status == 'running' %}
        const containerData = {
            vmid: '{{ container.vmid }}',
            name: '{{ container.name }}',
            node: '{{ node }}',
            status: '{{ container.status }}',
            cpu: {{ container.cpu|default(0) }},
            mem: {{ container.mem|default(0) }},
            maxmem: {{ container.maxmem|default(1) }}
            {% if container.get('rootfs') %}
            ,
            rootfs: {
                usage: {{ container.rootfs.get('usage')|default(0) }},
                total: {{ container.rootfs.get('total')|default(1) }}
            }
            {% endif %}
        };
        ResourceAlerts.checkContainerResources(containerData);
        {% endif %}
        {% endfor %}
        {% endif %}
    });
</script>
{% endblock %}