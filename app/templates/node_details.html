{% extends "base.html" %}

{% block title %}Proxmox UI - Node Details{% endblock %}

{% block content %}
<div class="breadcrumb-container py-2 px-3 mb-3 position-relative w-100 rounded-3 bg-dark">
    <nav aria-label="breadcrumb" class="d-flex justify-content-between align-items-center">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}" class="text-light">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('host_details', host_id=host_id) }}" class="text-light">{{ host_id }}</a></li>
            <li class="breadcrumb-item active text-light">{{ node }}</li>
        </ol>
        <div class="d-flex flex-wrap gap-1">
            <a href="{{ url_for('create_vm', host_id=host_id, node=node) }}" class="btn btn-sm btn-outline-light">
                <i class="fas fa-plus-circle"></i> Create VM
            </a>
            <a href="{{ url_for('create_container', host_id=host_id, node=node) }}" class="btn btn-sm btn-outline-light">
                <i class="fas fa-plus-circle"></i> Create CT
            </a>
            <a href="{{ url_for('batch_create', host_id=host_id, node=node) }}" class="btn btn-sm btn-outline-light">
                <i class="fas fa-layer-group"></i> Batch Create
            </a>
            <a href="{{ url_for('batch_config', host_id=host_id, node=node) }}" class="btn btn-sm btn-outline-light">
                <i class="fas fa-sliders-h"></i> Batch Config
            </a>
            <a href="{{ url_for('template_management', host_id=host_id, node=node) }}" class="btn btn-sm btn-outline-light">
                <i class="fas fa-box-open"></i> Templates
            </a>
            <a href="{{ url_for('node_network', host_id=host_id, node=node) }}" class="btn btn-sm btn-outline-light">
                <i class="fas fa-network-wired"></i> Network
            </a>
            <a href="{{ url_for('node_firewall', host_id=host_id, node=node) }}" class="btn btn-sm btn-outline-light">
                <i class="fas fa-shield-alt"></i> Firewall
            </a>
            <a href="{{ url_for('node_metrics', host_id=host_id, node=node) }}" class="btn btn-sm btn-outline-light">
                <i class="fas fa-chart-line"></i> Metrics
            </a>
            <a href="{{ url_for('migrate_vm_form', host_id=host_id) }}" class="btn btn-sm btn-outline-light">
                <i class="fas fa-exchange-alt"></i> Migrate
            </a>
            <a href="{{ url_for('node_maintenance', host_id=host_id, node=node) }}" class="btn btn-sm btn-outline-light">
                <i class="fas fa-wrench"></i> Maintenance
            </a>
        </div>
    </nav>
</div>

<div class="row mb-4">
    <div class="col">
        <!-- <h1><i class="fas fa-server"></i> Node: {{ node }}</h1> -->
    </div>
</div>

<!-- Resource Alerts Container -->
<div id="node-resource-alerts-container"></div>

<!-- Resource Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-success text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-0">Virtual Machines</h6>
                        <h1 class="mt-2 mb-0 display-5">{{ vms|length }}</h1>
                        <small>{{ vms|selectattr('status', 'equalto', 'running')|list|length }} running</small>
                    </div>
                    <div>
                        <i class="fas fa-desktop fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-0">Containers</h6>
                        <h1 class="mt-2 mb-0 display-5">{{ containers|length }}</h1>
                        <small>{{ containers|selectattr('status', 'equalto', 'running')|list|length }} running</small>
                    </div>
                    <div>
                        <i class="fas fa-cube fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-secondary text-white h-100">
            <div class="card-body">
                <div>
                    <h6 class="card-title mb-0"><i class="fas fa-heartbeat me-1"></i> Health</h6>
                    
                    <!-- CPU Health -->
                    <div class="d-flex align-items-center mt-2">
                        <small><i class="fas fa-microchip me-1"></i>CPU:</small>
                        <div class="progress ms-2 flex-grow-1" style="height: 0.6rem;">
                            <div class="progress-bar 
                                {% if node_status.cpu * 100 < 50 %}
                                    bg-success
                                {% elif node_status.cpu * 100 < 80 %}
                                    bg-warning
                                {% else %}
                                    bg-danger
                                {% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ node_status.cpu * 100 }}%;" 
                                 aria-valuenow="{{ node_status.cpu * 100 }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <small class="ms-1">{{ (node_status.cpu * 100)|round(1) }}%</small>
                    </div>
                    
                    <!-- Memory Health -->
                    <div class="d-flex align-items-center mt-2">
                        <small><i class="fas fa-memory me-1"></i>RAM:</small>
                        <div class="progress ms-2 flex-grow-1" style="height: 0.6rem;">
                            <div class="progress-bar 
                                {% if (node_status.memory.used / node_status.memory.total * 100) < 50 %}
                                    bg-success
                                {% elif (node_status.memory.used / node_status.memory.total * 100) < 80 %}
                                    bg-warning
                                {% else %}
                                    bg-danger
                                {% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ (node_status.memory.used / node_status.memory.total * 100)|round(2) }}%;" 
                                 aria-valuenow="{{ (node_status.memory.used / node_status.memory.total * 100)|round(2) }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <small class="ms-1">{{ (node_status.memory.used / node_status.memory.total * 100)|round(1) }}%</small>
                    </div>
                    
                    <!-- Storage Health -->
                    <div class="d-flex align-items-center mt-2">
                        <small><i class="fas fa-hdd me-1"></i>Disk:</small>
                        <div class="progress ms-2 flex-grow-1" style="height: 0.6rem;">
                            <div class="progress-bar 
                                {% if node_status.rootfs.used / node_status.rootfs.total * 100 < 50 %}
                                    bg-success
                                {% elif node_status.rootfs.used / node_status.rootfs.total * 100 < 80 %}
                                    bg-warning
                                {% else %}
                                    bg-danger
                                {% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ node_status.rootfs.used / node_status.rootfs.total * 100 }}%;" 
                                 aria-valuenow="{{ node_status.rootfs.used / node_status.rootfs.total * 100 }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <small class="ms-1">{{ (node_status.rootfs.used / node_status.rootfs.total * 100)|round(1) }}%</small>
                    </div>
                </div>
                
                <div class="mt-3 pt-2 border-top border-light">
                    <small class="text-light">Uptime:</small>
                    <div class="uptime-display">{{ (node_status.uptime / 86400)|round(1) }} days</div>
                </div>
            </div>
        </div>
    </div>
</div>

<ul class="nav nav-tabs mb-4" id="nodeTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="vms-tab" data-bs-toggle="tab" data-bs-target="#vms" type="button" role="tab" aria-controls="vms" aria-selected="true">
            Virtual Machines
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="containers-tab" data-bs-toggle="tab" data-bs-target="#containers" type="button" role="tab" aria-controls="containers" aria-selected="false">
            Containers
        </button>
    </li>
</ul>

<div class="tab-content" id="nodeTabContent">
    <div class="tab-pane fade show active" id="vms" role="tabpanel" aria-labelledby="vms-tab">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="bulk-actions-vm d-none">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-success btn-sm bulk-action-vm" data-action="start">
                            <i class="fas fa-play"></i> Start Selected
                        </button>
                        <button type="button" class="btn btn-warning btn-sm bulk-action-vm" data-action="shutdown">
                            <i class="fas fa-power-off"></i> Shutdown Selected
                        </button>
                        <button type="button" class="btn btn-danger btn-sm bulk-action-vm" data-action="stop">
                            <i class="fas fa-stop"></i> Stop Selected
                        </button>
                        <button type="button" class="btn btn-primary btn-sm bulk-migrate-btn" data-type="qemu">
                            <i class="fas fa-exchange-alt"></i> Migrate Selected
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" id="vm-select-none">
                            <i class="fas fa-times"></i> Clear Selection
                        </button>
                    </div>
                    <span class="ms-2 badge bg-primary" id="vm-selected-count">0 selected</span>
                </div>
            </div>
            <div class="card-body">
                {% if vms %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="vmsTable">
                            <thead>
                                <tr>
                                    <th>
                                        <div class="form-check">
                                            <input class="form-check-input select-all-vm" type="checkbox" value="" id="select-all-vm">
                                            <label class="form-check-label" for="select-all-vm"></label>
                                        </div>
                                    </th>
                                    <th class="sortable" data-sort="vmid">VMID <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="name">Name <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="status">Status <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="memory">Memory <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="cpu">CPU <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="tags">Tags <i class="fas fa-sort"></i></th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vm in vms %}
                                <tr>
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input vm-checkbox" type="checkbox" 
                                                data-vmid="{{ vm.vmid }}" data-status="{{ vm.status }}" data-node="{{ node }}">
                                        </div>
                                    </td>
                                    <td data-value="{{ vm.vmid }}">{{ vm.vmid }}</td>
                                    <td data-value="{{ vm.name }}">{{ vm.name }}</td>
                                    <td data-value="{{ vm.status }}">
                                        {% if vm.status == 'running' %}
                                            <span class="badge bg-success">Running</span>
                                        {% elif vm.status == 'stopped' %}
                                            <span class="badge bg-danger">Stopped</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ vm.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td data-value="{{ vm.maxmem }}">{{ (vm.maxmem / (1024*1024))|round(0) }} MB</td>
                                    <td data-value="{% if vm.cpus is defined %}{{ vm.cpus }}{% elif vm.maxcpu is defined %}{{ vm.maxcpu }}{% else %}0{% endif %}">
                                        {% if vm.cpus is defined %}.maxmem / (1024*1024)) / 1024) %}
                                            {{ vm.cpus }}gb == memory_gb|round(0) %}
                                        {% elif vm.maxcpu is defined %}nt }} GB
                                            {{ vm.maxcpu }}
                                        {% else %} memory_gb|round(1) }} GB
                                            N/Aendif %}
                                        {% endif %}
                                    </td>   {{ (vm.maxmem / (1024*1024))|round(0) }} MB
                                    <td data-value="{{ vm.tags|default('') }}">
                                        {% if vm.tags is defined and vm.tags %}
                                            {% for tag in vm.tags.split(',') %}{{ vm.cpus }}{% elif vm.maxcpu is defined %}{{ vm.maxcpu }}{% else %}0{% endif %}">
                                                <span class="badge bg-info">{{ tag }}</span>
                                            {% endfor %}}
                                        {% else %}.maxcpu is defined %}
                                            <small class="text-muted">No tags</small>
                                        {% endif %}
                                    </td>   N/A
                                    <td>{% endif %}
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('vm_details', host_id=host_id, node=node, vmid=vm.vmid) }}" class="btn btn-info btn-sm">
                                                <i class="fas fa-info-circle"></i>
                                            </a>or tag in vm.tags.split(',') %}
                                                <span class="badge bg-info">{{ tag }}</span>
                                            {% if vm.status == 'running' %}
                                                <button type="button" class="btn btn-warning btn-sm vm-action" data-action="shutdown" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ vm.vmid }}">
                                                    <i class="fas fa-power-off"></i>>
                                                </button>
                                                <button type="button" class="btn btn-danger btn-sm vm-action" data-action="stop" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ vm.vmid }}">
                                                    <i class="fas fa-stop"></i>
                                                </button>roup" role="group">
                                                <button type="button" class="btn btn-secondary btn-sm vm-action" data-action="reset" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ vm.vmid }}">
                                                    <i class="fas fa-redo"></i>/i>
                                                </button>
                                            {% else %}
                                                <button type="button" class="btn btn-success btn-sm vm-action" data-action="start" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ vm.vmid }}">
                                                    <i class="fas fa-play"></i>n btn-warning btn-sm vm-action" data-action="shutdown" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ vm.vmid }}">
                                                </button>ass="fas fa-power-off"></i>
                                            {% endif %}n>
                                        </div>  <button type="button" class="btn btn-danger btn-sm vm-action" data-action="stop" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ vm.vmid }}">
                                    </td>           <i class="fas fa-stop"></i>
                                </tr>           </button>
                                {% endfor %}    <button type="button" class="btn btn-secondary btn-sm vm-action" data-action="reset" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ vm.vmid }}">
                            </tbody>                <i class="fas fa-redo"></i>
                        </table>                </button>
                    </div>                  {% else %}
                {% else %}                      <button type="button" class="btn btn-success btn-sm vm-action" data-action="start" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ vm.vmid }}">
                    <div class="alert alert-info">No virtual machines found on this node.</div>
                {% endif %}                     </button>
            </div>                          {% endif %}
        </div>                          </div>
    </div>                          </td>
                                </tr>
    <div class="tab-pane fade" id="containers" role="tabpanel" aria-labelledby="containers-tab">
        <div class="card">  </tbody>
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="bulk-actions-ct d-none">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-success btn-sm bulk-action-ct" data-action="start">
                            <i class="fas fa-play"></i> Start Selected
                        </button>
                        <button type="button" class="btn btn-warning btn-sm bulk-action-ct" data-action="shutdown">
                            <i class="fas fa-power-off"></i> Shutdown Selected
                        </button>
                        <button type="button" class="btn btn-danger btn-sm bulk-action-ct" data-action="stop">
                            <i class="fas fa-stop"></i> Stop Selected
                        </button>er d-flex justify-content-between align-items-center">
                        <button type="button" class="btn btn-primary btn-sm bulk-migrate-btn" data-type="lxc">
                            <i class="fas fa-exchange-alt"></i> Migrate Selected
                        </button>ype="button" class="btn btn-success btn-sm bulk-action-ct" data-action="start">
                        <button type="button" class="btn btn-secondary btn-sm" id="ct-select-none">
                            <i class="fas fa-times"></i> Clear Selection
                        </button>ype="button" class="btn btn-warning btn-sm bulk-action-ct" data-action="shutdown">
                    </div>  <i class="fas fa-power-off"></i> Shutdown Selected
                    <span class="ms-2 badge bg-primary" id="ct-selected-count">0 selected</span>
                </div>  <button type="button" class="btn btn-danger btn-sm bulk-action-ct" data-action="stop">
            </div>          <i class="fas fa-stop"></i> Stop Selected
            <div class="card-body">
                {% if containers %}e="button" class="btn btn-primary btn-sm bulk-migrate-btn" data-type="lxc">
                    <div class="table-responsive">nge-alt"></i> Migrate Selected
                        <table class="table table-striped table-hover" id="containersTable">
                            <thead>e="button" class="btn btn-secondary btn-sm" id="ct-select-none">
                                <tr>="fas fa-times"></i> Clear Selection
                                    <th>
                                        <div class="form-check">
                                            <input class="form-check-input select-all-ct" type="checkbox" value="" id="select-all-ct">
                                            <label class="form-check-label" for="select-all-ct"></label>
                                        </div>
                                    </th>
                                    <th class="sortable" data-sort="ctid">CTID <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="name">Name <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="status">Status <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="memory">Memory <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="cpu">CPU <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="tags">Tags <i class="fas fa-sort"></i></th>
                                    <th>Actions</th>form-check">
                                </tr>       <input class="form-check-input select-all-ct" type="checkbox" value="" id="select-all-ct">
                            </thead>        <label class="form-check-label" for="select-all-ct"></label>
                            <tbody>     </div>
                                {% for container in containers %}
                                <tr><th class="sortable" data-sort="ctid">CTID <i class="fas fa-sort"></i></th>
                                    <td>class="sortable" data-sort="name">Name <i class="fas fa-sort"></i></th>
                                        <div class="form-check">rt="status">Status <i class="fas fa-sort"></i></th>
                                            <input class="form-check-input ct-checkbox" type="checkbox" "></i></th>
                                                data-vmid="{{ container.vmid }}" data-status="{{ container.status }}" data-node="{{ node }}">
                                        </div>"sortable" data-sort="tags">Tags <i class="fas fa-sort"></i></th>
                                    </td>ctions</th>
                                    <td data-value="{{ container.vmid }}">{{ container.vmid }}</td>
                                    <td data-value="{{ container.name }}">{{ container.name }}</td>
                                    <td data-value="{{ container.status }}">
                                        {% if container.status == 'running' %}
                                            <span class="badge bg-success">Running</span>
                                        {% elif container.status == 'stopped' %}
                                            <span class="badge bg-danger">Stopped</span>
                                        {% else %} class="form-check-input ct-checkbox" type="checkbox" 
                                            <span class="badge bg-secondary">{{ container.status }}</span>.status }}" data-node="{{ node }}">
                                        {% endif %}
                                    </td>
                                    <td data-value="{{ container.maxmem }}">
                                        {% if (container.maxmem / (1024*1024)) >= 1024 %}
                                            {% set memory_gb = ((container.maxmem / (1024*1024)) / 1024) %}">
                                            {% if memory_gb == memory_gb|round(0) %}= 'running' %}
                                                {{ memory_gb|round(0)|int }} GBning</span>
                                            {% else %}= 'stopped' %}
                                                {{ memory_gb|round(1) }} GBclass="badge bg-danger">Stopped</span>
                                            {% endif %} %}
                                        {% else %}lass="badge bg-secondary">{{ container.status }}</span>
                                            {{ (container.maxmem / (1024*1024))|round(0) }} MB% endif %}
                                        {% endif %}
                                    </td>
                                    <td data-value="{% if container.cpus is defined %}{{ container.cpus }}{% elif container.maxcpu is defined %}{{ container.maxcpu }}{% else %}0{% endif %}"> %}
                                        {% if container.cpus is defined %}24)) / 1024) %}
                                            {{ container.cpus }}_gb == memory_gb|round(0) %}
                                        {% elif container.maxcpu is defined %} memory_gb|round(0)|int }} GB
                                            {{ container.maxcpu }}
                                        {% else %}memory_gb|round(1) }} GB
                                            N/A   {% endif %}
                                        {% endif %}{% else %}
                                    </td>4))|round(0) }} MB
                                    <td data-value="{{ container.tags|default('') }}">
                                        {% if container.tags is defined and container.tags %}
                                            {% for tag in container.tags.split(',') %}ue="{% if container.cpus is defined %}{{ container.cpus }}{% elif container.maxcpu is defined %}{{ container.maxcpu }}{% else %}0{% endif %}">
                                                <span class="badge bg-info">{{ tag }}</span>f container.cpus is defined %}
                                            {% endfor %}
                                        {% else %}
                                            <small class="text-muted">No tags</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('container_details', host_id=host_id, node=node, vmid=container.vmid) }}" class="btn btn-info btn-sm"> container.tags|default('') }}">
                                                <i class="fas fa-info-circle"></i>
                                            </a>',') %}
                                            ss="badge bg-info">{{ tag }}</span>
                                            {% if container.status == 'running' %}}
                                                <button type="button" class="btn btn-warning btn-sm container-action" data-action="shutdown" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ container.vmid }}">e %}
                                                    <i class="fas fa-power-off"></i>   <small class="text-muted">No tags</small>
                                                </button>   {% endif %}
                                                <button type="button" class="btn btn-danger btn-sm container-action" data-action="stop" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ container.vmid }}">
                                                    <i class="fas fa-stop"></i><td>
                                                </button>        <div class="btn-group" role="group">
                                            {% else %}                  <a href="{{ url_for('container_details', host_id=host_id, node=node, vmid=container.vmid) }}" class="btn btn-info btn-sm">
                                                <button type="button" class="btn btn-success btn-sm container-action" data-action="start" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ container.vmid }}">                      <i class="fas fa-info-circle"></i>
                                                    <i class="fas fa-play"></i>
                                                </button>                 
                                            {% endif %}                          {% if container.status == 'running' %}
                                        </div>                                  <button type="button" class="btn btn-warning btn-sm container-action" data-action="shutdown" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ container.vmid }}">
                                    </td>                                          <i class="fas fa-power-off"></i>
                                </tr>                                          </button>
                                {% endfor %}                                                <button type="button" class="btn btn-danger btn-sm container-action" data-action="stop" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ container.vmid }}">
                            </tbody>                       <i class="fas fa-stop"></i>
                        </table>
                    </div>              {% else %}
                {% else %}             <button type="button" class="btn btn-success btn-sm container-action" data-action="start" data-host-id="{{ host_id }}" data-node="{{ node }}" data-vmid="{{ container.vmid }}">
                    <div class="alert alert-info">No containers found on this node.</div>              <i class="fas fa-play"></i>
                {% endif %}
            </div>
        </div>                      </div>
    </div></td>
</div>

<!-- Bulk Migration Modal -->
<div class="modal fade" id="bulkMigrateModal" tabindex="-1" aria-labelledby="bulkMigrateModalLabel" aria-hidden="true">    </table>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkMigrateModalLabel">Migrate Selected Resources</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bulkMigrateForm">
                    <input type="hidden" id="bulkMigrateType" name="vm_type">
                    <input type="hidden" id="bulkMigrateItems" name="items">
                    ="bulkMigrateModal" tabindex="-1" aria-labelledby="bulkMigrateModalLabel" aria-hidden="true">
                    <div class="mb-3">l-dialog">
                        <label for="bulkTargetNode" class="form-label">Target Node</label>
                        <select class="form-select" id="bulkTargetNode" name="target_node" required>
                            <option value="">Select target node</option>>
                            {% for node_obj in nodes %}
                                {% if node_obj.node != node %}
                                    <option value="{{ node_obj.node }}">{{ node_obj.node }}</option>ss="modal-body">
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    lass="mb-3">
                    <div class="mb-3 form-check"> <label for="bulkTargetNode" class="form-label">Target Node</label>
                        <input type="checkbox" class="form-check-input" id="bulkOnline" name="online">      <select class="form-select" id="bulkTargetNode" name="target_node" required>
                        <label class="form-check-label" for="bulkOnline">Online Migration</label>lue="">Select target node</option>
                        <div class="form-text">If checked, resources will be live-migrated without downtime. This requires running resources.</div>
                    </div>
                                      <option value="{{ node_obj.node }}">{{ node_obj.node }}</option>
                    <div class="mb-3 form-check">                  {% endif %}
                        <input type="checkbox" class="form-check-input" id="bulkWithLocalDisks" name="with_local_disks">                  {% endfor %}
                        <label class="form-check-label" for="bulkWithLocalDisks">With Local Disks</label>                  </select>
                        <div class="form-text">If checked, local disks will be migrated as well (slower but maintains integrity).</div>      </div>
                    </div>                    
                </form> <div class="mb-3 form-check">
            </div>                <input type="checkbox" class="form-check-input" id="bulkOnline" name="online">
            <div class="modal-footer">ss="form-check-label" for="bulkOnline">Online Migration</label>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>ext">If checked, resources will be live-migrated without downtime. This requires running resources.</div>
                <button type="button" class="btn btn-primary" id="startBulkMigrate">Start Migration</button>
            </div>
        </div>
    </div> class="form-check-input" id="bulkWithLocalDisks" name="with_local_disks">
</div>ck-label" for="bulkWithLocalDisks">With Local Disks</label>
{% endblock %}            <div class="form-text">If checked, local disks will be migrated as well (slower but maintains integrity).</div>

{% block scripts %}
<script>
    $(document).ready(function() {ooter">
        // Individual VM/Container actionsutton" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        $('.vm-action').click(function() {on" class="btn btn-primary" id="startBulkMigrate">Start Migration</button>
            const action = $(this).data('action');
            const hostId = $(this).data('host-id');
            const node = $(this).data('node');
            const vmid = $(this).data('vmid');
            
            if (confirm(`Are you sure you want to ${action} VM ${vmid}?`)) {
                $.post('/api/vm/action', {
                    host_id: hostId,
                    node: node,
                    vmid: vmid,al VM/Container actions
                    action: actionm-action').click(function() {
                }).done(function(data) { const action = $(this).data('action');
                    if (data.success) {    const hostId = $(this).data('host-id');
                        alert('Action was successful. Page will reload.');
                        location.reload();
                    } else {
                        alert(`Error: ${data.error}`); to ${action} VM ${vmid}?`)) {
                    }
                }).fail(function() {        host_id: hostId,
                    alert('Failed to perform action. Please try again.');
                });
            }
        });n(data) {
        ccess) {
        $('.container-action').click(function() {ion was successful. Page will reload.');
            const action = $(this).data('action'););
            const hostId = $(this).data('host-id');
            const node = $(this).data('node');
            const vmid = $(this).data('vmid');
            tion() {
            if (confirm(`Are you sure you want to ${action} container ${vmid}?`)) {lease try again.');
                $.post('/api/container/action', {
                    host_id: hostId,
                    node: node,
                    vmid: vmid,
                    action: actionontainer-action').click(function() {
                }).done(function(data) { const action = $(this).data('action');
                    if (data.success) {            const hostId = $(this).data('host-id');
                        alert('Action was successful. Page will reload.'););
                        location.reload();;
                    } else {
                        alert(`Error: ${data.error}`); if (confirm(`Are you sure you want to ${action} container ${vmid}?`)) {
                    }                $.post('/api/container/action', {
                }).fail(function() {
                    alert('Failed to perform action. Please try again.');
                });
            }         action: action
        });                }).done(function(data) {

        // Bulk selection management for VMsd.');
        $('.vm-checkbox').change(function() {
            updateBulkActionsVisibility('vm');         } else {
        });                        alert(`Error: ${data.error}`);

        $('.select-all-vm').change(function() {
            $('.vm-checkbox').prop('checked', $(this).prop('checked'));ction. Please try again.');
            updateBulkActionsVisibility('vm');     });
        });            }

        $('#vm-select-none').click(function() {
            $('.vm-checkbox, .select-all-vm').prop('checked', false);
            updateBulkActionsVisibility('vm');.vm-checkbox').change(function() {
        });            updateBulkActionsVisibility('vm');

        // Bulk selection management for Containers
        $('.ct-checkbox').change(function() {{
            updateBulkActionsVisibility('ct'); $('.vm-checkbox').prop('checked', $(this).prop('checked'));
        });            updateBulkActionsVisibility('vm');

        $('.select-all-ct').change(function() {
            $('.ct-checkbox').prop('checked', $(this).prop('checked'));
            updateBulkActionsVisibility('ct');
        });

        $('#ct-select-none').click(function() {
            $('.ct-checkbox, .select-all-ct').prop('checked', false);ulk selection management for Containers
            updateBulkActionsVisibility('ct');ction() {
        });

        // Function to update bulk actions visibility
        function updateBulkActionsVisibility(type) {
            const checkboxSelector = type === 'vm' ? '.vm-checkbox:checked' : '.ct-checkbox:checked';('.ct-checkbox').prop('checked', $(this).prop('checked'));
            const actionsSelector = type === 'vm' ? '.bulk-actions-vm' : '.bulk-actions-ct';   updateBulkActionsVisibility('ct');
            const countSelector = type === 'vm' ? '#vm-selected-count' : '#ct-selected-count';        });
            
            const selectedCount = $(checkboxSelector).length;
            ('checked', false);
            if (selectedCount > 0) {');
                $(actionsSelector).removeClass('d-none');
                $(countSelector).text(`${selectedCount} selected`);
            } else {
                $(actionsSelector).addClass('d-none');Visibility(type) {
            }vm' ? '.vm-checkbox:checked' : '.ct-checkbox:checked';
        }m' ? '.bulk-actions-vm' : '.bulk-actions-ct';
'#vm-selected-count' : '#ct-selected-count';
        // Bulk actions for VMs
        $('.bulk-action-vm').click(function() {st selectedCount = $(checkboxSelector).length;
            const action = $(this).data('action');
            const hostId = '{{ host_id }}';
            const selectedVMs = [];lass('d-none');
            Selector).text(`${selectedCount} selected`);
            $('.vm-checkbox:checked').each(function() { else {
                selectedVMs.push({    $(actionsSelector).addClass('d-none');
                    node: $(this).data('node'),
                    vmid: $(this).data('vmid'),
                    status: $(this).data('status')
                });
            });
            
            if (selectedVMs.length === 0) {onst hostId = '{{ host_id }}';
                alert('No VMs selected.');const selectedVMs = [];
                return;
            }
            dVMs.push({
            // Filter VMs based on action       node: $(this).data('node'),
            let actionableVMs = selectedVMs;        vmid: $(this).data('vmid'),
            if (action === 'start') {
                actionableVMs = selectedVMs.filter(vm => vm.status !== 'running');
            } else if (action === 'stop' || action === 'shutdown') {
                actionableVMs = selectedVMs.filter(vm => vm.status === 'running');
            } === 0) {
            );
            if (actionableVMs.length === 0) {
                alert(`No VMs in a state where the "${action}" action can be performed.`);
                return;
            }sed on action
            
            if (confirm(`Are you sure you want to ${action} ${actionableVMs.length} VMs?`)) {n === 'start') {
                $.post('/api/bulk/vm/action', {ctedVMs.filter(vm => vm.status !== 'running');
                    host_id: hostId,
                    vms: JSON.stringify(actionableVMs),ionableVMs = selectedVMs.filter(vm => vm.status === 'running');
                    action: action
                }).done(function(data) { 
                    if (data.success) {            if (actionableVMs.length === 0) {
                        alert(`Action initiated for ${data.processed} VMs. Page will reload.`);te where the "${action}" action can be performed.`);
                        location.reload();
                    } else {
                        alert(`Error: ${data.error}`);
                    }want to ${action} ${actionableVMs.length} VMs?`)) {
                }).fail(function() {    $.post('/api/bulk/vm/action', {
                    alert('Failed to perform bulk action. Please try again.');
                });ctionableVMs),
            }
        });

        // Bulk actions for Containers     alert(`Action initiated for ${data.processed} VMs. Page will reload.`);
        $('.bulk-action-ct').click(function() {         location.reload();
            const action = $(this).data('action');        } else {
            const hostId = '{{ host_id }}';}`);
            const selectedContainers = [];
            (function() {
            $('.ct-checkbox:checked').each(function() {       alert('Failed to perform bulk action. Please try again.');
                selectedContainers.push({    });
                    node: $(this).data('node'),
                    vmid: $(this).data('vmid'),
                    status: $(this).data('status')
                });
            });
            
            if (selectedContainers.length === 0) {onst hostId = '{{ host_id }}';
                alert('No containers selected.');const selectedContainers = [];
                return;
            }
            dContainers.push({
            // Filter containers based on action       node: $(this).data('node'),
            let actionableContainers = selectedContainers;        vmid: $(this).data('vmid'),
            if (action === 'start') {
                actionableContainers = selectedContainers.filter(container => container.status !== 'running');
            } else if (action === 'stop' || action === 'shutdown') {
                actionableContainers = selectedContainers.filter(container => container.status === 'running');
            }.length === 0) {
            ected.');
            if (actionableContainers.length === 0) {
                alert(`No containers in a state where the "${action}" action can be performed.`);
                return;
            }ners based on action
            ers;
            if (confirm(`Are you sure you want to ${action} ${actionableContainers.length} containers?`)) {n === 'start') {
                $.post('/api/bulk/container/action', { = selectedContainers.filter(container => container.status !== 'running');
                    host_id: hostId,
                    containers: JSON.stringify(actionableContainers),ionableContainers = selectedContainers.filter(container => container.status === 'running');
                    action: action
                }).done(function(data) { 
                    if (data.success) {            if (actionableContainers.length === 0) {
                        alert(`Action initiated for ${data.processed} containers. Page will reload.`); containers in a state where the "${action}" action can be performed.`);
                        location.reload();
                    } else {
                        alert(`Error: ${data.error}`);
                    }you sure you want to ${action} ${actionableContainers.length} containers?`)) {
                }).fail(function() {    $.post('/api/bulk/container/action', {
                    alert('Failed to perform bulk action. Please try again.');
                });rs: JSON.stringify(actionableContainers),
            }
        });

        // Bulk migration     alert(`Action initiated for ${data.processed} containers. Page will reload.`);
        $('.bulk-migrate-btn').click(function() {         location.reload();
            const type = $(this).data('type');        } else {
            const selector = type === 'qemu' ? '.vm-checkbox:checked' : '.ct-checkbox:checked'; ${data.error}`);
            const items = [];
            (function() {
            $(selector).each(function() {       alert('Failed to perform bulk action. Please try again.');
                items.push({    });
                    node: $(this).data('node'),
                    vmid: $(this).data('vmid'),
                    status: $(this).data('status')
                });ulk migration
            });
            
            if (items.length === 0) {ype === 'qemu' ? '.vm-checkbox:checked' : '.ct-checkbox:checked';
                alert('No resources selected for migration.');
                return;
            }
               items.push({
            // Set modal values        node: $(this).data('node'),
            $('#bulkMigrateType').val(type);'vmid'),
            $('#bulkMigrateItems').val(JSON.stringify(items));
            
            // Handle online migration option based on selected resources });
            const hasRunning = items.some(item => item.status === 'running');            
            if (!hasRunning) {= 0) {
                $('#bulkOnline').prop('checked', false).prop('disabled', true);migration.');
            } else {
                $('#bulkOnline').prop('disabled', false);
            }
            
            // Show the migration modal
            const migrateModal = new bootstrap.Modal(document.getElementById('bulkMigrateModal'));
            migrateModal.show();
        });igration option based on selected resources
.status === 'running');
        // Start bulk migrationning) {
        $('#startBulkMigrate').click(function() {   $('#bulkOnline').prop('checked', false).prop('disabled', true);
            const hostId = '{{ host_id }}';} else {
            const type = $('#bulkMigrateType').val();
            const items = JSON.parse($('#bulkMigrateItems').val());
            const targetNode = $('#bulkTargetNode').val();
            const online = $('#bulkOnline').prop('checked');
            const withLocalDisks = $('#bulkWithLocalDisks').prop('checked');= new bootstrap.Modal(document.getElementById('bulkMigrateModal'));
            
            if (!targetNode) {
                alert('Please select a target node.');
                return;
            }nction() {
            
            if (confirm(`Are you sure you want to migrate ${items.length} resources to node ${targetNode}?`)) {pe').val();
                $.post('/api/bulk/migrate', {ON.parse($('#bulkMigrateItems').val());
                    host_id: hostId,l();
                    items: $('#bulkMigrateItems').val(),ine = $('#bulkOnline').prop('checked');
                    type: type,('#bulkWithLocalDisks').prop('checked');
                    target_node: targetNode,
                    online: online,rgetNode) {
                    with_local_disks: withLocalDisksalert('Please select a target node.');
                }).done(function(data) {
                    if (data.success) {
                        alert(`Migration initiated for ${data.processed} resources. Page will reload.`);
                        location.reload(); if (confirm(`Are you sure you want to migrate ${items.length} resources to node ${targetNode}?`)) {
                    } else {                $.post('/api/bulk/migrate', {
                        alert(`Error: ${data.error}`);
                    } $('#bulkMigrateItems').val(),
                }).fail(function() {
                    alert('Failed to start migration. Please try again.');etNode,
                });
                
                // Hide the modal
                bootstrap.Modal.getInstance(document.getElementById('bulkMigrateModal')).hide();
            });
        });              location.reload();
            } else {
        // Check node resources against thresholds and display alerts if needed: ${data.error}`);
        const nodeData = {
            name: '{{ node }}',        }).fail(function() {
            host_id: '{{ host_id }}',ion. Please try again.');
            cpu: {{ node_status.cpu * 100 }},
            memory_percent: {{ (node_status.memory.used / node_status.memory.total * 100)|round(2) }},
            memory_used: {{ (node_status.memory.used / (1024*1024*1024))|round(2) }},
            memory_total: {{ (node_status.memory.total / (1024*1024*1024))|round(2) }},p.Modal.getInstance(document.getElementById('bulkMigrateModal')).hide();
            storage_percent: {{ (node_status.rootfs.used / node_status.rootfs.total * 100)|round(2) }}
        };
        
        // Check resource thresholdst thresholds and display alerts if needed
        ResourceAlerts.checkNodeResources(nodeData);
        
        // Check VM resources if they are running
        {% if vms is defined %}* 100 }},
        {% for vm in vms %}emory_percent: {{ (node_status.memory.used / node_status.memory.total * 100)|round(2) }},
        {% if vm.status == 'running' %}sed: {{ (node_status.memory.used / (1024*1024*1024))|round(2) }},
        const vmData = {4*1024))|round(2) }},
            vmid: '{{ vm.vmid }}',100)|round(2) }}
            name: '{{ vm.name }}',
            node: '{{ node }}',
            status: '{{ vm.status }}',
            cpu: {{ vm.cpu|default(0) }},;
            mem: {{ vm.mem|default(0) }},
            maxmem: {{ vm.maxmem|default(1) }}s if they are running
            {% if vm.get('disks') %} vms is defined %}
            ,s %}
            disks: { if vm.status == 'running' %}
                {% for key, disk in vm.get('disks', {}).items() %}
                {% if disk.get('usage') is defined and disk.get('total') is defined %}{{ vm.vmid }}',
                '{{ key }}': {{ vm.name }}',
                    usage: {{ disk.get('usage') }},{{ node }}',
                    total: {{ disk.get('total') }}    status: '{{ vm.status }}',
                }{% if not loop.last %},{% endif %}
                {% endif %}}},
                {% endfor %}1) }}
            }
            {% endif %}
        };
        ResourceAlerts.checkVmResources(vmData);t('disks', {}).items() %}
        {% endif %}'usage') is defined and disk.get('total') is defined %}
        {% endfor %}
        {% endif %}}},
        }}
        // Check container resources if they are running
        {% if containers is defined %}
        {% for container in containers %}   {% endfor %}
        {% if container.status == 'running' %}
        const containerData = {
            vmid: '{{ container.vmid }}',
            name: '{{ container.name }}',rceAlerts.checkVmResources(vmData);
            node: '{{ node }}',
            status: '{{ container.status }}', endfor %}
            cpu: {{ container.cpu|default(0) }},
            mem: {{ container.mem|default(0) }},
            maxmem: {{ container.maxmem|default(1) }}tainer resources if they are running
            {% if container.get('rootfs') %}iners is defined %}
            , {% for container in containers %}
            rootfs: {% if container.status == 'running' %}
                usage: {{ container.rootfs.get('usage')|default(0) }},containerData = {











{% endblock %}</script>    });        {% endif %}        {% endfor %}        {% endif %}        ResourceAlerts.checkContainerResources(containerData);        };            {% endif %}            }                total: {{ container.rootfs.get('total')|default(1) }}            vmid: '{{ container.vmid }}',
            name: '{{ container.name }}',
            node: '{{ node }}',
            status: '{{ container.status }}',
            cpu: {{ container.cpu|default(0) }},
            mem: {{ container.mem|default(0) }},
            maxmem: {{ container.maxmem|default(1) }}
            {% if container.get('rootfs') %}
            ,
            rootfs: {
                usage: {{ container.rootfs.get('usage')|default(0) }},
                total: {{ container.rootfs.get('total')|default(1) }}
            }
            {% endif %}
        };
        ResourceAlerts.checkContainerResources(containerData);
        {% endif %}
        {% endfor %}
        {% endif %}
    });
</script>
{% endblock %}